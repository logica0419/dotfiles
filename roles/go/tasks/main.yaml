- name: Install Go
  block:
    - name: Check Current Go Version
      ansible.builtin.shell:
        executable: /bin/bash
        cmd: |
          set -o pipefail
          go version | cut -f 3 -d " "
      register: current
      changed_when: false
      failed_when: false
    - name: Check Latest Go Version
      ansible.builtin.shell:
        executable: /bin/bash
        cmd: |
          set -o pipefail
          curl -s https://go.dev/dl/?mode=json | jq -r .[0].version
      register: latest
      changed_when: false
    - name: Install Latest Go
      become: true
      when: current.stdout != latest.stdout
      block:
        - name: Remove Old Installation
          ansible.builtin.command: rm -rf /usr/local/go
          changed_when: false
        - name: Download Latest Go
          ansible.builtin.uri:
            url: https://go.dev/dl/{{ latest.stdout }}.linux-amd64.tar.gz
            dest: /tmp/go-latest.tar.gz
            status_code:
              - 200
              - 304
        - name: Extract Latest Go
          ansible.builtin.unarchive:
            src: /tmp/go-latest.tar.gz
            remote_src: true
            dest: /usr/local

- name: Install Go Packages
  go_install:
    name: "{{ item }}"
  loop:
    - github.com/cweill/gotests/gotests
    - github.com/fatih/gomodifytags
    - github.com/josharian/impl
    - github.com/haya14busa/goplay/cmd/goplay
    - github.com/go-delve/delve/cmd/dlv
    - github.com/golangci/golangci-lint/cmd/golangci-lint
    - golang.org/x/tools/gopls
    - golang.org/x/tools/cmd/goimports
    - github.com/nao1215/gup
    - github.com/cosmtrek/air
    - github.com/go-bun/bun-starter-kit/cmd/bun
    - github.com/spf13/cobra-cli
    - github.com/matsuu/go-mysql-query-digest
    - mvdan.cc/gofumpt
    - github.com/praetorian-inc/gokart
    - github.com/ryutoyasugi/gomod-tree
    - github.com/projectdiscovery/httpx/cmd/httpx
    - github.com/magefile/mage
    - github.com/golang/mock/mockgen
    - github.com/gostaticanalysis/skeleton/v2
    - github.com/google/wire/cmd/wire
    - github.com/traefik/mocktail
    - google.golang.org/protobuf/cmd/protoc-gen-go
    - connectrpc.com/connect/cmd/protoc-gen-connect-go
    - golang.org/dl/go1.20.6 # for AtCoder

- name: Download go1.20.6
  ansible.builtin.command: go1.20.6 download
  changed_when: false
