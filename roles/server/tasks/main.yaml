- name: Set timezone to Asia/Tokyo
  become: true
  community.general.timezone:
    name: Asia/Tokyo

- name: Copy SSH keys to root home
  become: true
  ansible.builtin.copy:
    src: /home/{{ ansible_user }}/.ssh/
    dest: /root/.ssh/
    mode: "0755"
    owner: root
    group: root
    remote_src: true

- name: Setup Tailscale
  become: true
  block:
    - name: Get Tailscale install script
      ansible.builtin.get_url:
        url: https://tailscale.com/install.sh
        dest: /tmp/install.sh
        mode: "0755"
    - name: Install Tailscale
      ansible.builtin.command: /tmp/install.sh
      changed_when: false
    - name: Enable auto update
      ansible.builtin.command: tailscale set --auto-update
      changed_when: false

- name: Setup VS Code server
  block:
    - name: Install code CLI
      become: true
      ansible.builtin.unarchive:
        src: https://code.visualstudio.com/sha/download?build=stable&os=cli-alpine-x64
        dest: /usr/local/bin/
        remote_src: true
        mode: "0755"
    - name: Enable linger state
      ansible.builtin.command: loginctl enable-linger {{ ansible_user }}
      changed_when: false
    - name: Create VS Code settings directory
      ansible.builtin.file:
        path: /home/{{ ansible_user }}/.vscode-server/data/Machine
        state: directory
        mode: "0755"
    - name: Copy VS Code settings
      ansible.builtin.copy:
        src: settings.json
        dest: /home/{{ ansible_user }}/.vscode-server/data/Machine/settings.json
        mode: "0644"

- name: Setup updater
  block:
    - name: Get current dir path
      ansible.builtin.command: pwd
      register: server_dotfiles_dir
      changed_when: false
    - name: Get ansible-playbook path
      ansible.builtin.command: which ansible-playbook
      register: server_ansible_playbook_path
      changed_when: false
    - name: Setup updater for server
      ansible.builtin.cron:
        name: update packages
        minute: 0
        hour: 4
        user: "{{ ansible_user }}"
        job: >-
          {{ server_ansible_playbook_path.stdout }} -v -u {{ ansible_user }}
          -i {{ server_dotfiles_dir.stdout }}/inventory {{ server_dotfiles_dir.stdout }}/update.yaml

- name: Setup reboot (update detection)
  become: true
  block:
    - name: Get reboot path
      ansible.builtin.command: which reboot
      register: server_reboot_path
      changed_when: false
    - name: Setup periodical reboot (update detection)
      ansible.builtin.cron:
        name: reboot server (update detection)
        minute: 30
        hour: 4
        user: root
        job: "[ -e /var/run/reboot-required ] && {{ server_reboot_path.stdout }} 0"
    - name: Check if tailscale is up
      ansible.builtin.command: ping -c 1 logica-server.tailccba4.ts.net
      register: server_tailscale_check
      changed_when: false
      ignore_errors: true
    - name: Setup periodical reboot (connectivity check)
      ansible.builtin.cron:
        name: reboot server (connectivity check)
        user: root
        job: >-
          ssh -o StrictHostKeyChecking=no logica-server.tailccba4.ts.net
          curl -m 3 -sL log.tailscale.com >/dev/null || {{ server_reboot_path.stdout }} 0
      when: server_tailscale_check is succeeded

- name: Disable sleep mode
  become: true
  block:
    - name: Disable suspend
      ansible.builtin.lineinfile:
        path: /etc/systemd/sleep.conf
        regexp: "[#]{0,1}AllowSuspend"
        line: "AllowSuspend=no"
    - name: Disable hibernate
      ansible.builtin.lineinfile:
        path: /etc/systemd/sleep.conf
        regexp: "[#]{0,1}AllowHibernation"
        line: "AllowHibernation=no"
    - name: Disable suspend then hibernate
      ansible.builtin.lineinfile:
        path: /etc/systemd/sleep.conf
        regexp: "[#]{0,1}AllowSuspendThenHibernate"
        line: "AllowSuspendThenHibernate=no"
    - name: Disable hybrid sleep
      ansible.builtin.lineinfile:
        path: /etc/systemd/sleep.conf
        regexp: "[#]{0,1}AllowHybridSleep"
        line: "AllowHybridSleep=no"
    - name: Mask sleep-related targets
      ansible.builtin.systemd:
        name: "{{ item }}"
        masked: true
      loop:
        - sleep.target
        - suspend.target
        - hibernate.target
        - hybrid-sleep.target
    - name: Restart systemd-logind
      ansible.builtin.systemd:
        name: systemd-logind
        state: restarted
